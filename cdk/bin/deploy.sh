#!/bin/zsh

yellow='\033[0;33m'
red='\033[0;31m'
blue='\033[0;34m'
green='\033[0;32m'
reset='\033[0m'


print_hacker(){

  echo -e '\033[0;32m
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£€â£„â €â €â €â €â €â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¤â£¶â¡â ‰â €â ™â¢§â¡€â €â €â €â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£ â ¿â ‰â €â €â €â €â €â ˆâ¢³â¡„â €â €â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â¡¼â â €â €â €â €â €â €â €â €â €â¢»â¡„â €â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â¡¤â£¿â ›â ¶â ¤â €â €â €â €â €â €â €â €â ˆâ£·â¡€â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¾â£¥â£ˆâ ‰â ’â ¦â£„â €â£€â €â €â €â €â €â €â ¸â¡‡â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¿â£¿â ›â “â ²â£„â ˆâ ³â¡Œâ ³â¡€â €â €â €â¢¸â£·â¡‡â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢°â£¿â£¿â¡‡â €â €â ˆâ ³â¡€â ˆâ¢¦â¡¹â¡€â €â €â¢¸â ƒâ¢§â €â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£¿â Ÿâ¢³â£¤â €â¢»â¡¿â£†â €â¢³â¡—â €â €â¡¼â €â¢¸â¡†â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â£¿â£¿â£·â£¤â¡Ÿâ €â €â ˆâ ›â£†â €â¢·â €â €â¡‡â €â ¨â¢§â €â €â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ¹â£¿â£¿â£¿â£§â£ â €â €â €â ˜â£†â ˆâ ƒâ£°â â €â „â ¸â£¦â¡€â €â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢»â£¿â£¿â£¿â£·â¡„â €â €â €â ¸â¡…â¢€â¡â €â €â €â¢ â â ±â£„â €â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¿â£¿â£¿â£¿â£·â£¤â£ â –â¢»â â¡¼â €â €â¢€â¡´â ‹â €â €â ˆâ¢¦â¡€â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£´â¡Ÿâ ‰â¢»â¡»â£¿â£¿â£¿â¢§â£ â¢â£¾â£¡â ¤â šâ£â €â €â €â €â €â €â ‰â £â¡„â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â¡â¡¿â â¢ â¢¿â£¿â¢¿â£¿â¡¿â ‹â£¿â¡â ‰â €â €â €â£¹â¡â â €â €â €â €â €â €â¢¸â¡€
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â¡‡â£†â¡´â¡Ÿâ¢¸â¢¸â¢°â¡„â €â €â£¹â¢±â €â €â €â¢°â¢¿â¡„â €â €â €â €â €â €â €â €â¢§
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£½â ƒâ£¿â €â ƒâ¢¸â¢¸â ˜â¡‡â €â €â£¿â¢¸â €â €â €â ƒâ €â¢§â¡„â¢€â¡´â ƒâ €â €â €â €â ˜
  â£€â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£´â¢¿â¡§â£¿â €â €â¡¸â£¾â €â¡‡â €â €â£¯â¡â €â €â €â €â €â£¸â¡·â£«â£´â €â €â €â¢€â ‚â¢€
  â ˜â£¿â£¦â£„â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¼â£‡â €â €â£¿â €â €â¡‡â£¿â °â ‡â €â£¸â¢»â ‡â €â €â €â €â¢°â ¿â â£«â¢â¡ â €â¢€â ‚â €â¢¸
  â €â ˜â£¿â£¿â£¿â£¦â£„â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¡¾â£â »â£¦â£¤â£¿â €â €â¢§â¡‡â €â €â €â¢¹â£¾â €â €â €â €â¢ â¡â£ â£¼â£‹â£‰â£€â£´â£â£€â£€â¡
  â €â €â ˆâ¢¿â£¿â£¿â£¿â£¿â£¦â£„â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£ â£·â¡Œâ ™â ºâ¢­â¡¿â €â €â ¸â †â €â €â €â¢¸â£¿â¡€â €â €â €â¡Ÿâ¢€â¡§â£„â£ â£ â£¤â£¤â£¤â£€â£ˆâ¡‡
  â €â €â €â ˆâ¢¿â£¿â£¿â£¿â£¿â£¿â£·â£¦â£€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£ â ¿â ƒâ €â ˆâ ¢â â¢¤â£§â €â €â €â €â €â €â €â¢¸â¡¿â €â €â €â£¼â â¡¼â ‰â ›â ’â ’â ’â ’â ¶â ¶â¢¿â 
  â €â €â €â €â €â¢¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£·â£¦â¡€â €â €â €â €â €â €â €â €â €â¡€â €â €â¢€â£¤â£›â¡›â ›â¢¢â €â €â¢ â ˆâ¢ªâ£»â¡‡â €â €â €â €â €â €â â ƒâ €â €â¢°â â¢¸â¡§â ¤â ¤â ¤â¢¤â£€â£€â¡€â €â¡¾â €
  â €â €â €â €â €â €â¢»â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡„â €â£€â£€â ¤â ´â ’â šâ£©â ½â£¿â –â ‹â ‰â €â €â£¦â ˆâ£§â €â ˆâ£³â£¼â¡¿â ›â €â €â €â €â €â €â €â¢€â¡¤â ´â â €â£¿â “â ¢â ¤â ¤â ¤â ¤â£Œâ£‰â£»â¡‡â €
  â €â €â €â €â €â €â €â ¹â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£­â£­â£¶â£¦â£¤â£¶â ‹â¢¡â£´â ‡â¢€â£´â¡¦â €â£ â¢¿â£¤â£¿â¡´â ’â¢¹â£â£€â €â €â¢€â£€â£€â €â €â¢€â£ â£„â¢€â£¤â£¾â¡¯â¡€â €â ‰â ’â ’â ¤â¢¤â£­â£½â €â €
  â €â €â €â €â €â €â €â €â ™â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â â¢ â£»â ƒâ¡´â ›â¢â£´â¡¯â ‡â €â €â ˆâ ‰â ‰â ‰â¢¹â¡â ‰â ‰â ™â£·â ˆâ¢»â ‰â »â €â ˜â£Ÿâ »â €â¡‰â â €â €â €â €â €â €â£ â£¿â €â €
  â €â €â €â €â €â €â €â €â €â €â ™â¢¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¾â£¿â£®â£µâ¢°â£§â£â£¶â¡¿â¢‹â£¡â ”â šâ£€â¡€â €â €â €â €â¢¨â ‡â €â €â €â¢¹â €â ˆâ â €â €â €â ¿â €â €â ˆâ “â ¶â „â €â â£²â¡¾â ‹â¡¿â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ »â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¾â¡¿â¢¿â£¿â¢â¢ â Ÿâ¡ â£¾â Ÿâ¢‹â¡ â ¤â ¤â¢¤â ¤â ¾â ¤â ¤â£¤â¢¤â¡¼â €â €â €â €â €â €â €â €â €â €â €â €â£€â¡´â â â¢€â£´â ‡â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ ›â¢¿â£¿â£¿â£¿â£¿â¡™â »â£¿â£¿â£¿â£¿â£â¡‹â£®â£´â£â£¥â¡„â €â €â¢€â£€â¡¤â ´â šâ ›â ªâ£Ÿâ¡§â¢¤â£„â£ â£„â¡â ¦â£¤â£¤â£¤â ´â šâ ‰â €â €â €â£¾â â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ™â »â£¿â£¿â£¿â¡„â ˆâ ™â¢¿â£¿â£¿â£¿â£¿â Ÿâ ‹â£â£¤â ´â šâ ‰â â €â €â €â €â €â €â ‰â ²â¢¤â¡€â ‰â ‰â ‰â ‰â â €â €â €â €â €â €â¢€â£¿â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ »â¢¿â£¿â¡„â €â €â¢™â£¹â£·â ¶â Ÿâ ‹â â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ ‘â ¦â£„â €â €â €â €â €â €â €â °â¢šâ¡‡â €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ™â ¿â¡¾â ¿â ›â ‰â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ™â ‚â €â €â €â €â €â ˆâ ›â ƒâ €â €â €â €
  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
  \033[0m'

}
deploy_stack() {
    echo "ğŸ‘·ï¸${yellow}Deploying stack:${reset} $1"
    if [[ $1 == *"Fargate"* ]]; then
      countdown 360 $1
    fi

    npx aws-cdk deploy $1 --require-approval never
    if [[ $exit_code -eq 1 ]]; then
        exit
    fi

    if [[ $1 == *"Ecr"* ]]; then
      echo "Do you wish to upload your DockerImage now?"
          echo -n "-> "
          read Response

          case $Response in

          [yY])
              build_docker $1
              ;;
          [nN])
              echo "Skipping image build..."
              ;;
          * ) echo "Please pick a valid option";
          esac
    fi
}

countdown() {
    duration=$1
    stack_name=$2

    printf "\n ${yellow}Sleeping for $((duration/60)) minute(s) before deploying $stack_name..."
    printf "\n You can press the Enter key to skip this waiting period (NOT ADVISED IF DOCKER IMAGE WAS NOT BUILT). \n"

    while [[ $duration -gt 0 ]]
    do
        printf "\râ³  ${yellow}Time remaining â³ :${reset} %02d:%02d" $((duration/60)) $((duration%60))
        read -k 1 -t 1 input
        if [[ $input == $'\n' ]]; then
            echo -e "\nâŒ›  ${red}Waiting period canceled${reset} âŒ› "
            echo -e "ğŸ‘·ï¸${green}Continuing with deployment ğŸ‘·${reset}"
            return
        fi
        ((duration--))
    done

    echo -e "\nâŒ›  ${green}Waiting period finished${reset} âŒ› "
    echo -e "ğŸ‘·ï¸${green}Continuing with deployment ğŸ‘·${reset}"
}

build_docker() {
  output=$(aws cloudformation describe-stacks --stack-name "$1" --query 'Stacks[0].Outputs')

  # Use jq to extract the OutputValue and trim the text after "repository/"
  repository_output=$(echo "$output" | jq -r '.[] | select(.OutputValue | contains("repository/")) | .OutputValue' | sed 's/.*\/\([^"]*\)/\1/')

  # Get AWS account ID
  account_id=$(aws sts get-caller-identity --query "Account" --output text)

  # Get current AWS region
  region=$(aws configure get region)

  ecr_url="$account_id.dkr.ecr.$region.amazonaws.com"

  aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin $ecr_url

  cd ..
  image_tag=latest
  docker build -t $repository_output . --platform linux/amd64
  docker tag $repository_output:$image_tag "$ecr_url/$repository_output:$image_tag"
  docker push $ecr_url/$repository_output:$image_tag
  cd cdk
}

cd ..
print_hacker
printf "ğŸ‘·ï¸${green}Deploying environment ğŸ‘·  \nï¸ ${reset}"

for stack in $(cdk ls); do
  deploy_stack $stack
done

echo "âœ…  ${green}Deployment finished! âœ… "

pwd